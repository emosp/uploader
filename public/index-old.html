<!doctype html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>文件上传测试</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<style>
			.gradient-purple {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			}
			.gradient-purple-h {
				background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
			}

			/* 动态类样式 - JavaScript 使用 */
			.show {
				display: block !important;
			}

			#uploadArea.dragging {
				border-color: #764ba2;
				background-color: #e0e7ff;
			}

			/* 输入框验证状态 */
			#videoId.error {
				border-color: #f44336;
			}

			#videoId.success {
				border-color: #4caf50;
			}

			.input-hint.error {
				color: #f44336;
			}

			/* 视频信息动态内容样式 */
			.video-info-loading {
				display: flex;
				align-items: center;
				gap: 10px;
				color: #667eea;
			}

			.video-info-item {
				margin-bottom: 8px;
				padding: 8px 12px;
				background: white;
				border-radius: 6px;
			}

			.video-info-item strong {
				color: #667eea;
				margin-right: 8px;
			}

			.video-info-error {
				color: #f44336;
				background: #ffebee;
				padding: 12px;
				border-radius: 6px;
			}

			/* 状态消息样式 - 顶部通知 */
			.status-message {
				position: fixed;
				top: -100px;
				left: 50%;
				transform: translateX(-50%);
				z-index: 9999;
				padding: 16px 24px;
				border-radius: 8px;
				font-size: 14px;
				font-weight: 500;
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
				min-width: 300px;
				text-align: center;
				transition: top 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
			}

			.status-message.show {
				top: 100px;
			}

			.status-message.success {
				background: #d4edda;
				color: #155724;
				border: 1px solid #c3e6cb;
			}

			.status-message.error {
				background: #f8d7da;
				color: #721c24;
				border: 1px solid #f5c6cb;
			}

			.status-message.uploading {
				background: #d1ecf1;
				color: #0c5460;
				border: 1px solid #bee5eb;
			}
		</style>
	</head>
	<body class="gradient-purple min-h-screen flex items-center justify-center p-5">
		<!-- 顶部通知消息 -->
		<div class="status-message" id="statusMessage"></div>

		<div class="bg-white rounded-xl shadow-2xl p-10 max-w-5xl w-full">
			<h1 class="text-gray-800 mb-2 text-2xl font-bold">EMOS emby公益服 视频上传服务 <small class="text-gray-400">v0.0.1</small></h1>
			<p class="text-gray-600 mb-8 text-sm">支持上传到 Microsoft OneDrive</p>

			<!-- 用户信息和视频信息左右布局 -->
			<div class="flex gap-5 mb-6 flex-wrap lg:flex-nowrap items-start">
				<!-- 用户信息面板 (左侧 360px) -->
				<div class="gradient-purple rounded-xl p-5 shadow-lg w-full lg:w-[360px] shrink-0 self-start" id="userPanel">
					<div class="flex items-center gap-4 text-white" id="userLoggedOut">
						<div class="text-3xl bg-white/20 w-12 h-12 rounded-full flex items-center justify-center">👤</div>
						<div class="flex-1 text-base font-medium">未登录</div>
						<button id="loginBtn" class="px-6 py-2.5 bg-white text-indigo-500 rounded-lg text-sm font-semibold hover:-translate-y-0.5 hover:shadow-lg transition-all duration-300">登录</button>
					</div>
					<div class="flex items-center gap-4 text-white hidden" id="userLoggedIn">
						<div class="text-3xl bg-white/20 w-12 h-12 rounded-full flex items-center justify-center">👤</div>
						<div class="flex-1">
							<div class="text-base font-semibold" id="userName">用户名</div>
						</div>
						<button id="logoutBtn" class="px-5 py-2 bg-white/20 text-white border-2 border-white rounded-lg text-sm font-medium hover:bg-white hover:text-indigo-500 transition-all duration-300">登出</button>
					</div>
				</div>

				<!-- 视频信息区域 (右侧 480px) -->
				<div class="w-full lg:w-[480px] shrink-0">
					<div class="mb-4">
						<label for="videoId" class="block text-gray-800 font-medium mb-2 text-sm">视频 ID</label>
						<div class="flex gap-2.5">
							<input
								type="text"
								id="videoId"
								placeholder="输入 vl-123 或 ve-456"
								autocomplete="off"
								class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg text-sm transition-all duration-300 outline-none focus:border-indigo-500 focus:shadow-[0_0_0_3px_rgba(102,126,234,0.1)]"
							/>
							<button id="fetchVideoInfoBtn" type="button" class="gradient-purple px-5 py-3 text-white rounded-lg text-sm font-medium hover:-translate-y-0.5 hover:shadow-lg transition-all duration-300 whitespace-nowrap disabled:opacity-60 disabled:cursor-not-allowed disabled:transform-none">获取</button>
						</div>
						<div class="input-hint mt-1.5 text-xs text-gray-500">必须以 vl- 或 ve- 开头，后跟正整数</div>
					</div>

					<div class="video-info-container hidden bg-gray-100 rounded-lg p-5 mb-0" id="videoInfoContainer">
						<div class="font-semibold text-gray-800 mb-3 text-base">视频信息</div>
						<div class="text-gray-600 text-sm leading-relaxed" id="videoInfoContent">
							<p class="text-gray-500 italic m-0">输入视频 ID 并点击"获取"按钮</p>
						</div>
					</div>
				</div>
			</div>

			<div class="border-2 border-dashed border-indigo-500 rounded-lg p-10 text-center cursor-pointer transition-all duration-300 bg-indigo-50 hover:border-purple-600 hover:bg-indigo-100" id="uploadArea">
				<div class="text-5xl mb-2.5">📁</div>
				<div class="text-indigo-500 font-medium mb-1">点击或拖拽文件到此处上传</div>
				<div class="text-gray-500 text-xs">仅支持视频文件 (MP4, AVI, MOV, MKV 等)</div>
			</div>

			<input id="fetch" type="file" name="fetch" accept="video/*" class="hidden" />

			<div class="file-info hidden mt-5 p-4 bg-gray-100 rounded-lg" id="fileInfo">
				<div class="font-medium text-gray-800 mb-1" id="fileName"></div>
				<div class="text-gray-600 text-sm" id="fileSize"></div>
			</div>

			<div class="progress-container hidden mt-4" id="progressContainer">
				<div class="w-full h-2 bg-gray-300 rounded overflow-hidden mb-2.5">
					<div class="gradient-purple-h h-full w-0 transition-all duration-300" id="progressFill"></div>
				</div>
				<div class="flex justify-between text-xs text-gray-600">
					<span id="progressPercent">0%</span>
					<span id="progressSpeed"></span>
				</div>
			</div>

			<button class="reupload-btn hidden mt-4 px-6 py-3 gradient-purple text-white rounded-lg text-sm font-medium hover:-translate-y-0.5 hover:shadow-lg transition-all duration-300" id="reuploadBtn">🔄 重新上传</button>
		</div>

		<script type="module">
			const BASE_URL='https://dev.emos.lol'
			// exp 2025-10-14T10:08:27.762Z
			const upload_url =
				`https://my.microsoftpersonalcontent.com/personal/ef3b19bd0619ae22/_api/v2.0/drives/b!xvkGwd5UhEO0g-FduvLzriUmgqfOSmNHnygZ4tRgiQddJTBeTF9-S7EoMv2-03lt/items/013MWWN7SNWRO7C3ZPX5FZLWITBRJLFGY3/uploadSession?guid='468e6063-5351-49b5-9d52-e5965b8fcd7c'&dc=0&tempauth=v1e.eyJzaXRlaWQiOiJjMTA2ZjljNi01NGRlLTQzODQtYjQ4My1lMTVkYmFmMmYzYWUiLCJhcHBfZGlzcGxheW5hbWUiOiJlbW9zIiwiYXBwaWQiOiIzYzVhZGI0NC1jNGI1LTRlOWUtYjQwZC03YWM5MTliZTZkOWUiLCJhdWQiOiIwMDAwMDAwMy0wMDAwLTBmZjEtY2UwMC0wMDAwMDAwMDAwMDAvbXkubWljcm9zb2Z0cGVyc29uYWxjb250ZW50LmNvbUA5MTg4MDQwZC02YzY3LTRjNWItYjExMi0zNmEzMDRiNjZkYWQiLCJleHAiOiIxNzYwNTk0OTg2In0.y6NP1iMeGyRo4Q8dLtkNxNs6M0OscMARzMA8uDLSlXo9yC87CMZabvVDPqDNTkhfEAFLaYjQJR7z53Sht7nNu7Dx5HsFIWr2HsMXigwq1tXtgFpyy-jMy3YvAzTUBeIr0vQHtCkmD_J4mxgaLGji1VpBHN6CwoED-udeFGSU3etGvEnuCqZjoe7AGcCSwx41qmmwhWpOyKUEhsOXtC-p1iFmdlCtnZiagdwfSFF4TAmsFn9-1MoFQPJKI8T-kZi1bCNvj7kkrPsf_PHVYUofAw5qRGB1bpUj76lC_mlAbwM49nqkPXqvHSFLvp-zIF5qHcgU5bpXjyHAn3AinUZWjhKMNytDsNJC5AeG_LUasLjiVlE7ebf2q93LaHRSBUa6aRR0YnuIe-DGHjmX6wbQ5qWu8LoKP-BCq9IXuZKW3hpXteEWHEvTBL8ucsUzWUmXi0dp9b9RAN11msDDW5uJQg.SK4nXSkljIEK2ynNgbnWBUTzMs28QOLm0Yd_9I7ANAM`

			// 分片配置
			const CHUNK_SIZE = 5 * 1024 * 1024 // 5MB 每片
			const MIN_CHUNK_SIZE = 50 * 1024 * 1024 // 50MB 最小分片大小

			// ============ 用户认证相关 ============

			// 第三方登录 URL（需要替换为实际的登录地址）
			const LOGIN_URL = '/api/link?uuid=9dbf2c0c-7fa2-49a6-a37b-a4ebc9406049&name=上传项目'

			// 用户面板元素
			const loginBtn = document.getElementById('loginBtn')
			const logoutBtn = document.getElementById('logoutBtn')
			const userLoggedOut = document.getElementById('userLoggedOut')
			const userLoggedIn = document.getElementById('userLoggedIn')
			const userNameEl = document.getElementById('userName')

			// 状态消息元素(需要提前声明,因为用户认证部分会使用)
			const statusMessage = document.getElementById('statusMessage')
			let statusTimeout = null

			// 显示状态消息
			function showStatus(message, type) {
				// 清除之前的定时器
				if (statusTimeout) {
					clearTimeout(statusTimeout)
				}

				statusMessage.textContent = message
				statusMessage.className = `status-message show ${type}`

				// 2秒后自动隐藏
				statusTimeout = setTimeout(() => {
					hideStatus()
				}, 2000)
			}

			// 隐藏状态消息
			function hideStatus() {
				statusMessage.classList.remove('show')
				if (statusTimeout) {
					clearTimeout(statusTimeout)
					statusTimeout = null
				}
			}

			// 从 sessionStorage 获取用户信息
			function getUserInfo() {
				const token = sessionStorage.getItem('token')
				const username = sessionStorage.getItem('username')

				if (token && username) {
					return { token, username }
				}
				return null
			}

			// 保存用户信息到 sessionStorage
			function saveUserInfo(token, username) {
				sessionStorage.setItem('token', token)
				sessionStorage.setItem('username', username)
			}

			// 清除用户信息
			function clearUserInfo() {
				sessionStorage.removeItem('token')
				sessionStorage.removeItem('username')
			}

			// 更新用户面板显示
			function updateUserPanel() {
				const userInfo = getUserInfo()

				if (userInfo) {
					// 已登录状态
					userLoggedOut.style.display = 'none'
					userLoggedIn.style.display = 'flex'
					userNameEl.textContent = userInfo.username
					console.log('用户已登录:', userInfo)
				} else {
					// 未登录状态
					userLoggedOut.style.display = 'flex'
					userLoggedIn.style.display = 'none'
					console.log('用户未登录')
				}
			}

			// 处理登录回调
			function handleLoginCallback() {
				const urlParams = new URLSearchParams(window.location.search)
				const token = urlParams.get('token')
				const username = urlParams.get('username')

				if (token && username) {
					console.log('检测到登录回调，保存用户信息')
					saveUserInfo(token, username)

					// 清除 URL 中的参数
					const cleanUrl = window.location.origin + window.location.pathname
					window.history.replaceState({}, document.title, cleanUrl)

					// 更新用户面板
					updateUserPanel()

					showStatus('登录成功！', 'success')
				}
			}

			// 登录按钮点击事件
			loginBtn.addEventListener('click', () => {
				// 获取当前页面 URL 作为回调地址
				const callbackUrl = encodeURIComponent(window.location.href)
				// 跳转到第三方登录页面，携带 callback 参数
				const loginUrl = `${BASE_URL}${LOGIN_URL}&url=${callbackUrl}`

				console.log('跳转到登录页面:', loginUrl)
				window.location.href = loginUrl
			})

			// 登出按钮点击事件
			logoutBtn.addEventListener('click', () => {
				console.log('用户登出')
				clearUserInfo()
				updateUserPanel()
				showStatus('已登出', 'success')
			})

			// 页面加载时检查登录状态
			handleLoginCallback()
			updateUserPanel()

			// ============ 文件上传相关 ============

			const videoIdInput = document.getElementById('videoId')
			const fetchVideoInfoBtn = document.getElementById('fetchVideoInfoBtn')
			const videoInfoContainer = document.getElementById('videoInfoContainer')
			const videoInfoContent = document.getElementById('videoInfoContent')
			const uploadArea = document.getElementById('uploadArea')
			const fileInput = document.getElementById('fetch')
			const fileInfo = document.getElementById('fileInfo')
			const fileName = document.getElementById('fileName')
			const fileSize = document.getElementById('fileSize')
			const progressContainer = document.getElementById('progressContainer')
			const progressFill = document.getElementById('progressFill')
			const progressPercent = document.getElementById('progressPercent')
			const progressSpeed = document.getElementById('progressSpeed')
			const reuploadBtn = document.getElementById('reuploadBtn')

			// 当前上传控制器（用于取消上传）
			let currentUploadController = null
			// 保存最后上传的文件，用于重新上传
			let lastUploadedFile = null

			// 获取视频信息
			async function fetchVideoInfo(videoId) {
				fetchVideoInfoBtn.disabled = true
				fetchVideoInfoBtn.textContent = '获取中...'
				videoInfoContainer.classList.add('show')

				videoInfoContent.innerHTML = '<div class="video-info-loading">⏳ 正在获取视频信息...</div>'

				try {
					// 解析视频 ID，提取 item_type 和 item_id
					// 格式: vl-123 或 ve-456
					const match = videoId.match(/^(vl|ve)-(\d+)$/)
					if (!match) {
						throw new Error('视频 ID 格式错误')
					}

					const item_type = match[1]
					const item_id = match[2]

					const apiUrl = `${BASE_URL}/api/upload/base?item_type=${item_type}&item_id=${item_id}`

					const response = await fetch(apiUrl)

					if (!response.ok) {
						throw new Error(`HTTP ${response.status}: ${response.statusText}`)
					}

					const data = await response.json()

					// 显示视频信息
					videoInfoContent.innerHTML = `
						<div class="video-info-item"><strong>视频ID:</strong> ${data.id || videoId}</div>
						<div class="video-info-item"><strong>标题:</strong> ${data.title || '未知'}</div>
						<div class="video-info-item"><strong>时长:</strong> ${data.duration || '未知'}</div>
						<div class="video-info-item"><strong>分辨率:</strong> ${data.resolution || '未知'}</div>
						<div class="video-info-item"><strong>大小:</strong> ${data.size ? formatFileSize(data.size) : '未知'}</div>
						<div class="video-info-item"><strong>状态:</strong> ${data.status || '未知'}</div>
					`

					console.log('视频信息:', data)
				} catch (error) {
					videoInfoContent.innerHTML = `
						<div class="video-info-error">
							❌ 获取视频信息失败: ${error.message}
							<br><br>
							<small>提示: 请确保视频 ID 正确，且 API 端点已正确配置</small>
						</div>
					`
					console.error('获取视频信息失败:', error)
				} finally {
					fetchVideoInfoBtn.disabled = false
					fetchVideoInfoBtn.textContent = '获取'
				}
			}

			// 点击获取视频信息按钮
			fetchVideoInfoBtn.addEventListener('click', () => {
				const videoId = videoIdInput.value.trim()

				if (!videoId) {
					showStatus('错误：请先输入视频 ID！', 'error')
					videoIdInput.focus()
					return
				}

				if (!validateVideoId(videoId)) {
					showStatus('错误：视频 ID 格式不正确！', 'error')
					videoIdInput.focus()
					return
				}

				fetchVideoInfo(videoId)
			})

			// 验证视频 ID 格式
			function validateVideoId(value) {
				// 正则表达式：必须以 vl- 或 ve- 开头，后跟一个或多个数字
				const pattern = /^(vl|ve)-\d+$/
				return pattern.test(value)
			}

			// 处理视频 ID 输入
			videoIdInput.addEventListener('input', (e) => {
				const value = e.target.value.trim()
				// 获取提示元素：input 的父元素的下一个兄弟元素
				const hint = videoIdInput.parentElement.nextElementSibling

				if (value === '') {
					// 空值时重置样式
					videoIdInput.classList.remove('error', 'success')
					hint.classList.remove('error')
					hint.textContent = '必须以 vl- 或 ve- 开头，后跟正整数'
				} else if (validateVideoId(value)) {
					// 验证通过
					videoIdInput.classList.remove('error')
					videoIdInput.classList.add('success')
					hint.classList.remove('error')
					hint.textContent = '✓ 格式正确'
				} else {
					// 验证失败
					videoIdInput.classList.remove('success')
					videoIdInput.classList.add('error')
					hint.classList.add('error')
					hint.textContent = '✗ 格式错误：必须以 vl- 或 ve- 开头，后跟正整数'
				}
			})

			// 验证是否为视频文件
			function isVideoFile(file) {
				// 检查 MIME 类型
				if (file.type.startsWith('video/')) {
					return true
				}

				// 检查文件扩展名
				const videoExtensions = ['.mp4', '.avi', '.mov', '.mkv', '.wmv', '.flv', '.webm', '.m4v', '.mpeg', '.mpg', '.3gp']
				const fileName = file.name.toLowerCase()
				return videoExtensions.some(ext => fileName.endsWith(ext))
			}

			// 格式化文件大小
			function formatFileSize(bytes) {
				if (bytes === 0) return '0 Bytes'
				const k = 1024
				const sizes = ['Bytes', 'KB', 'MB', 'GB']
				const i = Math.floor(Math.log(bytes) / Math.log(k))
				return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i]
			}

			// 上传单个分片
			function uploadChunk(chunk, start, end, total) {
				return new Promise((resolve, reject) => {
					const xhr = new XMLHttpRequest()

					currentUploadController = {
						abort: () => xhr.abort()
					}

					xhr.addEventListener('load', () => {
						if (xhr.status >= 200 && xhr.status < 300) {
							resolve(xhr.responseText)
						} else {
							reject(new Error(`分片上传失败: ${xhr.status} ${xhr.statusText}`))
						}
					})

					xhr.addEventListener('error', () => {
						reject(new Error('网络错误'))
					})

					xhr.addEventListener('abort', () => {
						reject(new Error('上传已取消'))
					})

					xhr.open('PUT', upload_url)
					xhr.setRequestHeader('Content-Type', 'application/octet-stream')
					xhr.setRequestHeader('Content-Range', `bytes ${start}-${end}/${total}`)
					xhr.send(chunk)
				})
			}

			// 分片上传文件
			async function uploadFileInChunks(file) {
				const total = file.size
				const chunkSize = CHUNK_SIZE
				const chunks = Math.ceil(total / chunkSize)

				let uploadedBytes = 0
				const startTime = Date.now()

				console.log(`开始分片上传: 文件大小 ${formatFileSize(total)}, 分片数 ${chunks}, 每片 ${formatFileSize(chunkSize)}`)

				try {
					for (let i = 0; i < chunks; i++) {
						const start = i * chunkSize
						const end = Math.min(start + chunkSize, total) - 1
						const chunk = file.slice(start, end + 1)

						console.log(`上传分片 ${i + 1}/${chunks}: bytes ${start}-${end}/${total}`)

						showStatus(`正在上传分片 ${i + 1}/${chunks}...`, 'uploading')

						await uploadChunk(chunk, start, end, total)

						uploadedBytes = end + 1
						const percent = Math.round((uploadedBytes / total) * 100)
						progressFill.style.width = percent + '%'
						progressPercent.textContent = percent + '%'

						// 计算上传速度
						const elapsed = (Date.now() - startTime) / 1000
						const speed = uploadedBytes / elapsed
						progressSpeed.textContent = formatFileSize(speed) + '/s'

						console.log(`分片 ${i + 1} 上传成功`)
					}

					showStatus('上传成功！', 'success')
					console.log('所有分片上传完成')
				} catch (error) {
					throw error
				}
			}

			// 完整上传（小文件）
			async function uploadFileComplete(file) {
				const start = 0
				const end = file.size - 1
				const total = file.size
				const startTime = Date.now()

				console.log(`开始完整上传: ${formatFileSize(total)}`)

				return new Promise((resolve, reject) => {
					const xhr = new XMLHttpRequest()

					currentUploadController = {
						abort: () => xhr.abort()
					}

					xhr.upload.addEventListener('progress', (e) => {
						if (e.lengthComputable) {
							const percent = Math.round((e.loaded / e.total) * 100)
							progressFill.style.width = percent + '%'
							progressPercent.textContent = percent + '%'

							// 计算上传速度
							const elapsed = (Date.now() - startTime) / 1000
							const speed = e.loaded / elapsed
							progressSpeed.textContent = formatFileSize(speed) + '/s'
						}
					})

					xhr.addEventListener('load', () => {
						if (xhr.status >= 200 && xhr.status < 300) {
							showStatus('上传成功！', 'success')
							console.log('上传响应:', xhr.responseText)
							resolve(xhr.responseText)
						} else {
							const error = new Error(`上传失败: ${xhr.status} ${xhr.statusText}`)
							showStatus(error.message, 'error')
							console.error('上传失败:', xhr.status, xhr.statusText, xhr.responseText)
							reject(error)
						}
					})

					xhr.addEventListener('error', () => {
						const error = new Error('网络错误，上传失败')
						showStatus(error.message, 'error')
						console.error('网络错误')
						reject(error)
					})

					xhr.addEventListener('abort', () => {
						const error = new Error('上传已取消')
						showStatus(error.message, 'error')
						reject(error)
					})

					xhr.open('PUT', upload_url)
					xhr.setRequestHeader('Content-Type', 'application/octet-stream')
					xhr.setRequestHeader('Content-Range', `bytes ${start}-${end}/${total}`)
					xhr.send(file)
				})
			}

			// 上传文件（自动选择分片或完整上传）
			async function uploadFile(file) {
				if (!file) return

				// 隐藏重新上传按钮
				reuploadBtn.classList.remove('show')

				// 验证视频 ID
				const videoId = videoIdInput.value.trim()
				if (!videoId) {
					showStatus('错误：请先输入视频 ID！', 'error')
					videoIdInput.focus()
					return
				}

				if (!validateVideoId(videoId)) {
					showStatus('错误：视频 ID 格式不正确！', 'error')
					videoIdInput.focus()
					return
				}

				// 验证文件类型
				if (!isVideoFile(file)) {
					showStatus('错误：只能上传视频文件！', 'error')
					console.error('文件类型不支持:', file.type, file.name)
					return
				}

				// 保存文件以便重新上传
				lastUploadedFile = file

				// 显示文件信息
				fileName.textContent = `文件名: ${file.name}`
				fileSize.textContent = `大小: ${formatFileSize(file.size)} | 视频ID: ${videoId}`
				fileInfo.classList.add('show')
				progressContainer.classList.add('show')
				hideStatus()

				// 重置进度
				progressFill.style.width = '0%'
				progressPercent.textContent = '0%'
				progressSpeed.textContent = ''

				try {
					showStatus('正在准备上传...', 'uploading')

					// 根据文件大小选择上传方式
					if (file.size > MIN_CHUNK_SIZE) {
						console.log('使用分片上传模式')
						await uploadFileInChunks(file)
					} else {
						console.log('使用完整上传模式')
						await uploadFileComplete(file)
					}

					// 上传成功，不显示重新上传按钮
				} catch (error) {
					showStatus(`上传出错: ${error.message}`, 'error')
					console.error('上传异常:', error)
					// 上传失败时显示重新上传按钮
					reuploadBtn.classList.add('show')
				} finally {
					currentUploadController = null
				}
			}

			// 点击上传区域
			uploadArea.addEventListener('click', () => {
				fileInput.click()
			})

			// 文件选择
			fileInput.addEventListener('change', (event) => {
				const file = event.target.files[0]
				if (file) {
					uploadFile(file)
				}
			})

			// 拖拽上传
			uploadArea.addEventListener('dragover', (e) => {
				e.preventDefault()
				uploadArea.classList.add('dragging')
			})

			uploadArea.addEventListener('dragleave', () => {
				uploadArea.classList.remove('dragging')
			})

			uploadArea.addEventListener('drop', (e) => {
				e.preventDefault()
				uploadArea.classList.remove('dragging')

				const file = e.dataTransfer.files[0]
				if (file) {
					uploadFile(file)
				}
			})

			// 重新上传按钮点击事件
			reuploadBtn.addEventListener('click', () => {
				if (lastUploadedFile) {
					console.log('重新上传文件:', lastUploadedFile.name)
					uploadFile(lastUploadedFile)
				} else {
					showStatus('错误：没有可重新上传的文件！', 'error')
				}
			})
		</script>
	</body>
</html>
