<!doctype html>
<html lang="zh-CN">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<style>
			.gradient-purple {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			}
			.gradient-purple-h {
				background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
			}

			/* åŠ¨æ€ç±»æ ·å¼ - JavaScript ä½¿ç”¨ */
			.show {
				display: block !important;
			}

			#uploadArea.dragging {
				border-color: #764ba2;
				background-color: #e0e7ff;
			}

			/* è¾“å…¥æ¡†éªŒè¯çŠ¶æ€ */
			#videoId.error {
				border-color: #f44336;
			}

			#videoId.success {
				border-color: #4caf50;
			}

			.input-hint.error {
				color: #f44336;
			}

			/* è§†é¢‘ä¿¡æ¯åŠ¨æ€å†…å®¹æ ·å¼ */
			.video-info-loading {
				display: flex;
				align-items: center;
				gap: 10px;
				color: #667eea;
			}

			.video-info-item {
				margin-bottom: 8px;
				padding: 8px 12px;
				background: white;
				border-radius: 6px;
			}

			.video-info-item strong {
				color: #667eea;
				margin-right: 8px;
			}

			.video-info-error {
				color: #f44336;
				background: #ffebee;
				padding: 12px;
				border-radius: 6px;
			}

			/* çŠ¶æ€æ¶ˆæ¯æ ·å¼ - é¡¶éƒ¨é€šçŸ¥ */
			.status-message {
				position: fixed;
				top: -100px;
				left: 50%;
				transform: translateX(-50%);
				z-index: 9999;
				padding: 16px 24px;
				border-radius: 8px;
				font-size: 14px;
				font-weight: 500;
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
				min-width: 300px;
				text-align: center;
				transition: top 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
			}

			.status-message.show {
				top: 100px;
			}

			.status-message.success {
				background: #d4edda;
				color: #155724;
				border: 1px solid #c3e6cb;
			}

			.status-message.error {
				background: #f8d7da;
				color: #721c24;
				border: 1px solid #f5c6cb;
			}

			.status-message.uploading {
				background: #d1ecf1;
				color: #0c5460;
				border: 1px solid #bee5eb;
			}
		</style>
	</head>
	<body class="gradient-purple min-h-screen flex items-center justify-center p-5">
		<!-- é¡¶éƒ¨é€šçŸ¥æ¶ˆæ¯ -->
		<div class="status-message" id="statusMessage"></div>

		<div class="bg-white rounded-xl shadow-2xl p-10 max-w-5xl w-full">
			<h1 class="text-gray-800 mb-2 text-2xl font-bold">EMOS embyå…¬ç›Šæœ è§†é¢‘ä¸Šä¼ æœåŠ¡ <small class="text-gray-400">v0.0.1</small></h1>
			<p class="text-gray-600 mb-8 text-sm">æ”¯æŒä¸Šä¼ åˆ° Microsoft OneDrive</p>

			<!-- ç”¨æˆ·ä¿¡æ¯å’Œè§†é¢‘ä¿¡æ¯å·¦å³å¸ƒå±€ -->
			<div class="flex gap-5 mb-6 flex-wrap lg:flex-nowrap items-start">
				<!-- ç”¨æˆ·ä¿¡æ¯é¢æ¿ (å·¦ä¾§ 360px) -->
				<div class="gradient-purple rounded-xl p-5 shadow-lg w-full lg:w-[360px] shrink-0 self-start" id="userPanel">
					<div class="flex items-center gap-4 text-white" id="userLoggedOut">
						<div class="text-3xl bg-white/20 w-12 h-12 rounded-full flex items-center justify-center">ğŸ‘¤</div>
						<div class="flex-1 text-base font-medium">æœªç™»å½•</div>
						<button id="loginBtn" class="px-6 py-2.5 bg-white text-indigo-500 rounded-lg text-sm font-semibold hover:-translate-y-0.5 hover:shadow-lg transition-all duration-300">ç™»å½•</button>
					</div>
					<div class="flex items-center gap-4 text-white hidden" id="userLoggedIn">
						<div class="text-3xl bg-white/20 w-12 h-12 rounded-full flex items-center justify-center">ğŸ‘¤</div>
						<div class="flex-1">
							<div class="text-base font-semibold" id="userName">ç”¨æˆ·å</div>
						</div>
						<button id="logoutBtn" class="px-5 py-2 bg-white/20 text-white border-2 border-white rounded-lg text-sm font-medium hover:bg-white hover:text-indigo-500 transition-all duration-300">ç™»å‡º</button>
					</div>
				</div>

				<!-- è§†é¢‘ä¿¡æ¯åŒºåŸŸ (å³ä¾§ 480px) -->
				<div class="w-full lg:w-[480px] shrink-0">
					<div class="mb-4">
						<label for="videoId" class="block text-gray-800 font-medium mb-2 text-sm">è§†é¢‘ ID</label>
						<div class="flex gap-2.5">
							<input
								type="text"
								id="videoId"
								placeholder="è¾“å…¥ vl-123 æˆ– ve-456"
								autocomplete="off"
								class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg text-sm transition-all duration-300 outline-none focus:border-indigo-500 focus:shadow-[0_0_0_3px_rgba(102,126,234,0.1)]"
							/>
							<button id="fetchVideoInfoBtn" type="button" class="gradient-purple px-5 py-3 text-white rounded-lg text-sm font-medium hover:-translate-y-0.5 hover:shadow-lg transition-all duration-300 whitespace-nowrap disabled:opacity-60 disabled:cursor-not-allowed disabled:transform-none">è·å–</button>
						</div>
						<div class="input-hint mt-1.5 text-xs text-gray-500">å¿…é¡»ä»¥ vl- æˆ– ve- å¼€å¤´ï¼Œåè·Ÿæ­£æ•´æ•°</div>
					</div>

					<div class="video-info-container hidden bg-gray-100 rounded-lg p-5 mb-0" id="videoInfoContainer">
						<div class="font-semibold text-gray-800 mb-3 text-base">è§†é¢‘ä¿¡æ¯</div>
						<div class="text-gray-600 text-sm leading-relaxed" id="videoInfoContent">
							<p class="text-gray-500 italic m-0">è¾“å…¥è§†é¢‘ ID å¹¶ç‚¹å‡»"è·å–"æŒ‰é’®</p>
						</div>
					</div>
				</div>
			</div>

			<div class="border-2 border-dashed border-indigo-500 rounded-lg p-10 text-center cursor-pointer transition-all duration-300 bg-indigo-50 hover:border-purple-600 hover:bg-indigo-100" id="uploadArea">
				<div class="text-5xl mb-2.5">ğŸ“</div>
				<div class="text-indigo-500 font-medium mb-1">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </div>
				<div class="text-gray-500 text-xs">ä»…æ”¯æŒè§†é¢‘æ–‡ä»¶ (MP4, AVI, MOV, MKV ç­‰)</div>
			</div>

			<input id="fetch" type="file" name="fetch" accept="video/*" class="hidden" />

			<div class="file-info hidden mt-5 p-4 bg-gray-100 rounded-lg" id="fileInfo">
				<div class="font-medium text-gray-800 mb-1" id="fileName"></div>
				<div class="text-gray-600 text-sm" id="fileSize"></div>
			</div>

			<div class="progress-container hidden mt-4" id="progressContainer">
				<div class="w-full h-2 bg-gray-300 rounded overflow-hidden mb-2.5">
					<div class="gradient-purple-h h-full w-0 transition-all duration-300" id="progressFill"></div>
				</div>
				<div class="flex justify-between text-xs text-gray-600">
					<span id="progressPercent">0%</span>
					<span id="progressSpeed"></span>
				</div>
			</div>

			<button class="reupload-btn hidden mt-4 px-6 py-3 gradient-purple text-white rounded-lg text-sm font-medium hover:-translate-y-0.5 hover:shadow-lg transition-all duration-300" id="reuploadBtn">ğŸ”„ é‡æ–°ä¸Šä¼ </button>
		</div>

		<script type="module">
			const BASE_URL='https://dev.emos.lol'
			// exp 2025-10-14T10:08:27.762Z
			const upload_url =
				`https://my.microsoftpersonalcontent.com/personal/ef3b19bd0619ae22/_api/v2.0/drives/b!xvkGwd5UhEO0g-FduvLzriUmgqfOSmNHnygZ4tRgiQddJTBeTF9-S7EoMv2-03lt/items/013MWWN7SNWRO7C3ZPX5FZLWITBRJLFGY3/uploadSession?guid='468e6063-5351-49b5-9d52-e5965b8fcd7c'&dc=0&tempauth=v1e.eyJzaXRlaWQiOiJjMTA2ZjljNi01NGRlLTQzODQtYjQ4My1lMTVkYmFmMmYzYWUiLCJhcHBfZGlzcGxheW5hbWUiOiJlbW9zIiwiYXBwaWQiOiIzYzVhZGI0NC1jNGI1LTRlOWUtYjQwZC03YWM5MTliZTZkOWUiLCJhdWQiOiIwMDAwMDAwMy0wMDAwLTBmZjEtY2UwMC0wMDAwMDAwMDAwMDAvbXkubWljcm9zb2Z0cGVyc29uYWxjb250ZW50LmNvbUA5MTg4MDQwZC02YzY3LTRjNWItYjExMi0zNmEzMDRiNjZkYWQiLCJleHAiOiIxNzYwNTk0OTg2In0.y6NP1iMeGyRo4Q8dLtkNxNs6M0OscMARzMA8uDLSlXo9yC87CMZabvVDPqDNTkhfEAFLaYjQJR7z53Sht7nNu7Dx5HsFIWr2HsMXigwq1tXtgFpyy-jMy3YvAzTUBeIr0vQHtCkmD_J4mxgaLGji1VpBHN6CwoED-udeFGSU3etGvEnuCqZjoe7AGcCSwx41qmmwhWpOyKUEhsOXtC-p1iFmdlCtnZiagdwfSFF4TAmsFn9-1MoFQPJKI8T-kZi1bCNvj7kkrPsf_PHVYUofAw5qRGB1bpUj76lC_mlAbwM49nqkPXqvHSFLvp-zIF5qHcgU5bpXjyHAn3AinUZWjhKMNytDsNJC5AeG_LUasLjiVlE7ebf2q93LaHRSBUa6aRR0YnuIe-DGHjmX6wbQ5qWu8LoKP-BCq9IXuZKW3hpXteEWHEvTBL8ucsUzWUmXi0dp9b9RAN11msDDW5uJQg.SK4nXSkljIEK2ynNgbnWBUTzMs28QOLm0Yd_9I7ANAM`

			// åˆ†ç‰‡é…ç½®
			const CHUNK_SIZE = 5 * 1024 * 1024 // 5MB æ¯ç‰‡
			const MIN_CHUNK_SIZE = 50 * 1024 * 1024 // 50MB æœ€å°åˆ†ç‰‡å¤§å°

			// ============ ç”¨æˆ·è®¤è¯ç›¸å…³ ============

			// ç¬¬ä¸‰æ–¹ç™»å½• URLï¼ˆéœ€è¦æ›¿æ¢ä¸ºå®é™…çš„ç™»å½•åœ°å€ï¼‰
			const LOGIN_URL = '/api/link?uuid=9dbf2c0c-7fa2-49a6-a37b-a4ebc9406049&name=ä¸Šä¼ é¡¹ç›®'

			// ç”¨æˆ·é¢æ¿å…ƒç´ 
			const loginBtn = document.getElementById('loginBtn')
			const logoutBtn = document.getElementById('logoutBtn')
			const userLoggedOut = document.getElementById('userLoggedOut')
			const userLoggedIn = document.getElementById('userLoggedIn')
			const userNameEl = document.getElementById('userName')

			// çŠ¶æ€æ¶ˆæ¯å…ƒç´ (éœ€è¦æå‰å£°æ˜,å› ä¸ºç”¨æˆ·è®¤è¯éƒ¨åˆ†ä¼šä½¿ç”¨)
			const statusMessage = document.getElementById('statusMessage')
			let statusTimeout = null

			// æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
			function showStatus(message, type) {
				// æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
				if (statusTimeout) {
					clearTimeout(statusTimeout)
				}

				statusMessage.textContent = message
				statusMessage.className = `status-message show ${type}`

				// 2ç§’åè‡ªåŠ¨éšè—
				statusTimeout = setTimeout(() => {
					hideStatus()
				}, 2000)
			}

			// éšè—çŠ¶æ€æ¶ˆæ¯
			function hideStatus() {
				statusMessage.classList.remove('show')
				if (statusTimeout) {
					clearTimeout(statusTimeout)
					statusTimeout = null
				}
			}

			// ä» sessionStorage è·å–ç”¨æˆ·ä¿¡æ¯
			function getUserInfo() {
				const token = sessionStorage.getItem('token')
				const username = sessionStorage.getItem('username')

				if (token && username) {
					return { token, username }
				}
				return null
			}

			// ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° sessionStorage
			function saveUserInfo(token, username) {
				sessionStorage.setItem('token', token)
				sessionStorage.setItem('username', username)
			}

			// æ¸…é™¤ç”¨æˆ·ä¿¡æ¯
			function clearUserInfo() {
				sessionStorage.removeItem('token')
				sessionStorage.removeItem('username')
			}

			// æ›´æ–°ç”¨æˆ·é¢æ¿æ˜¾ç¤º
			function updateUserPanel() {
				const userInfo = getUserInfo()

				if (userInfo) {
					// å·²ç™»å½•çŠ¶æ€
					userLoggedOut.style.display = 'none'
					userLoggedIn.style.display = 'flex'
					userNameEl.textContent = userInfo.username
					console.log('ç”¨æˆ·å·²ç™»å½•:', userInfo)
				} else {
					// æœªç™»å½•çŠ¶æ€
					userLoggedOut.style.display = 'flex'
					userLoggedIn.style.display = 'none'
					console.log('ç”¨æˆ·æœªç™»å½•')
				}
			}

			// å¤„ç†ç™»å½•å›è°ƒ
			function handleLoginCallback() {
				const urlParams = new URLSearchParams(window.location.search)
				const token = urlParams.get('token')
				const username = urlParams.get('username')

				if (token && username) {
					console.log('æ£€æµ‹åˆ°ç™»å½•å›è°ƒï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯')
					saveUserInfo(token, username)

					// æ¸…é™¤ URL ä¸­çš„å‚æ•°
					const cleanUrl = window.location.origin + window.location.pathname
					window.history.replaceState({}, document.title, cleanUrl)

					// æ›´æ–°ç”¨æˆ·é¢æ¿
					updateUserPanel()

					showStatus('ç™»å½•æˆåŠŸï¼', 'success')
				}
			}

			// ç™»å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
			loginBtn.addEventListener('click', () => {
				// è·å–å½“å‰é¡µé¢ URL ä½œä¸ºå›è°ƒåœ°å€
				const callbackUrl = encodeURIComponent(window.location.href)
				// è·³è½¬åˆ°ç¬¬ä¸‰æ–¹ç™»å½•é¡µé¢ï¼Œæºå¸¦ callback å‚æ•°
				const loginUrl = `${BASE_URL}${LOGIN_URL}&url=${callbackUrl}`

				console.log('è·³è½¬åˆ°ç™»å½•é¡µé¢:', loginUrl)
				window.location.href = loginUrl
			})

			// ç™»å‡ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
			logoutBtn.addEventListener('click', () => {
				console.log('ç”¨æˆ·ç™»å‡º')
				clearUserInfo()
				updateUserPanel()
				showStatus('å·²ç™»å‡º', 'success')
			})

			// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
			handleLoginCallback()
			updateUserPanel()

			// ============ æ–‡ä»¶ä¸Šä¼ ç›¸å…³ ============

			const videoIdInput = document.getElementById('videoId')
			const fetchVideoInfoBtn = document.getElementById('fetchVideoInfoBtn')
			const videoInfoContainer = document.getElementById('videoInfoContainer')
			const videoInfoContent = document.getElementById('videoInfoContent')
			const uploadArea = document.getElementById('uploadArea')
			const fileInput = document.getElementById('fetch')
			const fileInfo = document.getElementById('fileInfo')
			const fileName = document.getElementById('fileName')
			const fileSize = document.getElementById('fileSize')
			const progressContainer = document.getElementById('progressContainer')
			const progressFill = document.getElementById('progressFill')
			const progressPercent = document.getElementById('progressPercent')
			const progressSpeed = document.getElementById('progressSpeed')
			const reuploadBtn = document.getElementById('reuploadBtn')

			// å½“å‰ä¸Šä¼ æ§åˆ¶å™¨ï¼ˆç”¨äºå–æ¶ˆä¸Šä¼ ï¼‰
			let currentUploadController = null
			// ä¿å­˜æœ€åä¸Šä¼ çš„æ–‡ä»¶ï¼Œç”¨äºé‡æ–°ä¸Šä¼ 
			let lastUploadedFile = null

			// è·å–è§†é¢‘ä¿¡æ¯
			async function fetchVideoInfo(videoId) {
				fetchVideoInfoBtn.disabled = true
				fetchVideoInfoBtn.textContent = 'è·å–ä¸­...'
				videoInfoContainer.classList.add('show')

				videoInfoContent.innerHTML = '<div class="video-info-loading">â³ æ­£åœ¨è·å–è§†é¢‘ä¿¡æ¯...</div>'

				try {
					// è§£æè§†é¢‘ IDï¼Œæå– item_type å’Œ item_id
					// æ ¼å¼: vl-123 æˆ– ve-456
					const match = videoId.match(/^(vl|ve)-(\d+)$/)
					if (!match) {
						throw new Error('è§†é¢‘ ID æ ¼å¼é”™è¯¯')
					}

					const item_type = match[1]
					const item_id = match[2]

					const apiUrl = `${BASE_URL}/api/upload/base?item_type=${item_type}&item_id=${item_id}`

					const response = await fetch(apiUrl)

					if (!response.ok) {
						throw new Error(`HTTP ${response.status}: ${response.statusText}`)
					}

					const data = await response.json()

					// æ˜¾ç¤ºè§†é¢‘ä¿¡æ¯
					videoInfoContent.innerHTML = `
						<div class="video-info-item"><strong>è§†é¢‘ID:</strong> ${data.id || videoId}</div>
						<div class="video-info-item"><strong>æ ‡é¢˜:</strong> ${data.title || 'æœªçŸ¥'}</div>
						<div class="video-info-item"><strong>æ—¶é•¿:</strong> ${data.duration || 'æœªçŸ¥'}</div>
						<div class="video-info-item"><strong>åˆ†è¾¨ç‡:</strong> ${data.resolution || 'æœªçŸ¥'}</div>
						<div class="video-info-item"><strong>å¤§å°:</strong> ${data.size ? formatFileSize(data.size) : 'æœªçŸ¥'}</div>
						<div class="video-info-item"><strong>çŠ¶æ€:</strong> ${data.status || 'æœªçŸ¥'}</div>
					`

					console.log('è§†é¢‘ä¿¡æ¯:', data)
				} catch (error) {
					videoInfoContent.innerHTML = `
						<div class="video-info-error">
							âŒ è·å–è§†é¢‘ä¿¡æ¯å¤±è´¥: ${error.message}
							<br><br>
							<small>æç¤º: è¯·ç¡®ä¿è§†é¢‘ ID æ­£ç¡®ï¼Œä¸” API ç«¯ç‚¹å·²æ­£ç¡®é…ç½®</small>
						</div>
					`
					console.error('è·å–è§†é¢‘ä¿¡æ¯å¤±è´¥:', error)
				} finally {
					fetchVideoInfoBtn.disabled = false
					fetchVideoInfoBtn.textContent = 'è·å–'
				}
			}

			// ç‚¹å‡»è·å–è§†é¢‘ä¿¡æ¯æŒ‰é’®
			fetchVideoInfoBtn.addEventListener('click', () => {
				const videoId = videoIdInput.value.trim()

				if (!videoId) {
					showStatus('é”™è¯¯ï¼šè¯·å…ˆè¾“å…¥è§†é¢‘ IDï¼', 'error')
					videoIdInput.focus()
					return
				}

				if (!validateVideoId(videoId)) {
					showStatus('é”™è¯¯ï¼šè§†é¢‘ ID æ ¼å¼ä¸æ­£ç¡®ï¼', 'error')
					videoIdInput.focus()
					return
				}

				fetchVideoInfo(videoId)
			})

			// éªŒè¯è§†é¢‘ ID æ ¼å¼
			function validateVideoId(value) {
				// æ­£åˆ™è¡¨è¾¾å¼ï¼šå¿…é¡»ä»¥ vl- æˆ– ve- å¼€å¤´ï¼Œåè·Ÿä¸€ä¸ªæˆ–å¤šä¸ªæ•°å­—
				const pattern = /^(vl|ve)-\d+$/
				return pattern.test(value)
			}

			// å¤„ç†è§†é¢‘ ID è¾“å…¥
			videoIdInput.addEventListener('input', (e) => {
				const value = e.target.value.trim()
				// è·å–æç¤ºå…ƒç´ ï¼šinput çš„çˆ¶å…ƒç´ çš„ä¸‹ä¸€ä¸ªå…„å¼Ÿå…ƒç´ 
				const hint = videoIdInput.parentElement.nextElementSibling

				if (value === '') {
					// ç©ºå€¼æ—¶é‡ç½®æ ·å¼
					videoIdInput.classList.remove('error', 'success')
					hint.classList.remove('error')
					hint.textContent = 'å¿…é¡»ä»¥ vl- æˆ– ve- å¼€å¤´ï¼Œåè·Ÿæ­£æ•´æ•°'
				} else if (validateVideoId(value)) {
					// éªŒè¯é€šè¿‡
					videoIdInput.classList.remove('error')
					videoIdInput.classList.add('success')
					hint.classList.remove('error')
					hint.textContent = 'âœ“ æ ¼å¼æ­£ç¡®'
				} else {
					// éªŒè¯å¤±è´¥
					videoIdInput.classList.remove('success')
					videoIdInput.classList.add('error')
					hint.classList.add('error')
					hint.textContent = 'âœ— æ ¼å¼é”™è¯¯ï¼šå¿…é¡»ä»¥ vl- æˆ– ve- å¼€å¤´ï¼Œåè·Ÿæ­£æ•´æ•°'
				}
			})

			// éªŒè¯æ˜¯å¦ä¸ºè§†é¢‘æ–‡ä»¶
			function isVideoFile(file) {
				// æ£€æŸ¥ MIME ç±»å‹
				if (file.type.startsWith('video/')) {
					return true
				}

				// æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
				const videoExtensions = ['.mp4', '.avi', '.mov', '.mkv', '.wmv', '.flv', '.webm', '.m4v', '.mpeg', '.mpg', '.3gp']
				const fileName = file.name.toLowerCase()
				return videoExtensions.some(ext => fileName.endsWith(ext))
			}

			// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
			function formatFileSize(bytes) {
				if (bytes === 0) return '0 Bytes'
				const k = 1024
				const sizes = ['Bytes', 'KB', 'MB', 'GB']
				const i = Math.floor(Math.log(bytes) / Math.log(k))
				return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i]
			}

			// ä¸Šä¼ å•ä¸ªåˆ†ç‰‡
			function uploadChunk(chunk, start, end, total) {
				return new Promise((resolve, reject) => {
					const xhr = new XMLHttpRequest()

					currentUploadController = {
						abort: () => xhr.abort()
					}

					xhr.addEventListener('load', () => {
						if (xhr.status >= 200 && xhr.status < 300) {
							resolve(xhr.responseText)
						} else {
							reject(new Error(`åˆ†ç‰‡ä¸Šä¼ å¤±è´¥: ${xhr.status} ${xhr.statusText}`))
						}
					})

					xhr.addEventListener('error', () => {
						reject(new Error('ç½‘ç»œé”™è¯¯'))
					})

					xhr.addEventListener('abort', () => {
						reject(new Error('ä¸Šä¼ å·²å–æ¶ˆ'))
					})

					xhr.open('PUT', upload_url)
					xhr.setRequestHeader('Content-Type', 'application/octet-stream')
					xhr.setRequestHeader('Content-Range', `bytes ${start}-${end}/${total}`)
					xhr.send(chunk)
				})
			}

			// åˆ†ç‰‡ä¸Šä¼ æ–‡ä»¶
			async function uploadFileInChunks(file) {
				const total = file.size
				const chunkSize = CHUNK_SIZE
				const chunks = Math.ceil(total / chunkSize)

				let uploadedBytes = 0
				const startTime = Date.now()

				console.log(`å¼€å§‹åˆ†ç‰‡ä¸Šä¼ : æ–‡ä»¶å¤§å° ${formatFileSize(total)}, åˆ†ç‰‡æ•° ${chunks}, æ¯ç‰‡ ${formatFileSize(chunkSize)}`)

				try {
					for (let i = 0; i < chunks; i++) {
						const start = i * chunkSize
						const end = Math.min(start + chunkSize, total) - 1
						const chunk = file.slice(start, end + 1)

						console.log(`ä¸Šä¼ åˆ†ç‰‡ ${i + 1}/${chunks}: bytes ${start}-${end}/${total}`)

						showStatus(`æ­£åœ¨ä¸Šä¼ åˆ†ç‰‡ ${i + 1}/${chunks}...`, 'uploading')

						await uploadChunk(chunk, start, end, total)

						uploadedBytes = end + 1
						const percent = Math.round((uploadedBytes / total) * 100)
						progressFill.style.width = percent + '%'
						progressPercent.textContent = percent + '%'

						// è®¡ç®—ä¸Šä¼ é€Ÿåº¦
						const elapsed = (Date.now() - startTime) / 1000
						const speed = uploadedBytes / elapsed
						progressSpeed.textContent = formatFileSize(speed) + '/s'

						console.log(`åˆ†ç‰‡ ${i + 1} ä¸Šä¼ æˆåŠŸ`)
					}

					showStatus('ä¸Šä¼ æˆåŠŸï¼', 'success')
					console.log('æ‰€æœ‰åˆ†ç‰‡ä¸Šä¼ å®Œæˆ')
				} catch (error) {
					throw error
				}
			}

			// å®Œæ•´ä¸Šä¼ ï¼ˆå°æ–‡ä»¶ï¼‰
			async function uploadFileComplete(file) {
				const start = 0
				const end = file.size - 1
				const total = file.size
				const startTime = Date.now()

				console.log(`å¼€å§‹å®Œæ•´ä¸Šä¼ : ${formatFileSize(total)}`)

				return new Promise((resolve, reject) => {
					const xhr = new XMLHttpRequest()

					currentUploadController = {
						abort: () => xhr.abort()
					}

					xhr.upload.addEventListener('progress', (e) => {
						if (e.lengthComputable) {
							const percent = Math.round((e.loaded / e.total) * 100)
							progressFill.style.width = percent + '%'
							progressPercent.textContent = percent + '%'

							// è®¡ç®—ä¸Šä¼ é€Ÿåº¦
							const elapsed = (Date.now() - startTime) / 1000
							const speed = e.loaded / elapsed
							progressSpeed.textContent = formatFileSize(speed) + '/s'
						}
					})

					xhr.addEventListener('load', () => {
						if (xhr.status >= 200 && xhr.status < 300) {
							showStatus('ä¸Šä¼ æˆåŠŸï¼', 'success')
							console.log('ä¸Šä¼ å“åº”:', xhr.responseText)
							resolve(xhr.responseText)
						} else {
							const error = new Error(`ä¸Šä¼ å¤±è´¥: ${xhr.status} ${xhr.statusText}`)
							showStatus(error.message, 'error')
							console.error('ä¸Šä¼ å¤±è´¥:', xhr.status, xhr.statusText, xhr.responseText)
							reject(error)
						}
					})

					xhr.addEventListener('error', () => {
						const error = new Error('ç½‘ç»œé”™è¯¯ï¼Œä¸Šä¼ å¤±è´¥')
						showStatus(error.message, 'error')
						console.error('ç½‘ç»œé”™è¯¯')
						reject(error)
					})

					xhr.addEventListener('abort', () => {
						const error = new Error('ä¸Šä¼ å·²å–æ¶ˆ')
						showStatus(error.message, 'error')
						reject(error)
					})

					xhr.open('PUT', upload_url)
					xhr.setRequestHeader('Content-Type', 'application/octet-stream')
					xhr.setRequestHeader('Content-Range', `bytes ${start}-${end}/${total}`)
					xhr.send(file)
				})
			}

			// ä¸Šä¼ æ–‡ä»¶ï¼ˆè‡ªåŠ¨é€‰æ‹©åˆ†ç‰‡æˆ–å®Œæ•´ä¸Šä¼ ï¼‰
			async function uploadFile(file) {
				if (!file) return

				// éšè—é‡æ–°ä¸Šä¼ æŒ‰é’®
				reuploadBtn.classList.remove('show')

				// éªŒè¯è§†é¢‘ ID
				const videoId = videoIdInput.value.trim()
				if (!videoId) {
					showStatus('é”™è¯¯ï¼šè¯·å…ˆè¾“å…¥è§†é¢‘ IDï¼', 'error')
					videoIdInput.focus()
					return
				}

				if (!validateVideoId(videoId)) {
					showStatus('é”™è¯¯ï¼šè§†é¢‘ ID æ ¼å¼ä¸æ­£ç¡®ï¼', 'error')
					videoIdInput.focus()
					return
				}

				// éªŒè¯æ–‡ä»¶ç±»å‹
				if (!isVideoFile(file)) {
					showStatus('é”™è¯¯ï¼šåªèƒ½ä¸Šä¼ è§†é¢‘æ–‡ä»¶ï¼', 'error')
					console.error('æ–‡ä»¶ç±»å‹ä¸æ”¯æŒ:', file.type, file.name)
					return
				}

				// ä¿å­˜æ–‡ä»¶ä»¥ä¾¿é‡æ–°ä¸Šä¼ 
				lastUploadedFile = file

				// æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
				fileName.textContent = `æ–‡ä»¶å: ${file.name}`
				fileSize.textContent = `å¤§å°: ${formatFileSize(file.size)} | è§†é¢‘ID: ${videoId}`
				fileInfo.classList.add('show')
				progressContainer.classList.add('show')
				hideStatus()

				// é‡ç½®è¿›åº¦
				progressFill.style.width = '0%'
				progressPercent.textContent = '0%'
				progressSpeed.textContent = ''

				try {
					showStatus('æ­£åœ¨å‡†å¤‡ä¸Šä¼ ...', 'uploading')

					// æ ¹æ®æ–‡ä»¶å¤§å°é€‰æ‹©ä¸Šä¼ æ–¹å¼
					if (file.size > MIN_CHUNK_SIZE) {
						console.log('ä½¿ç”¨åˆ†ç‰‡ä¸Šä¼ æ¨¡å¼')
						await uploadFileInChunks(file)
					} else {
						console.log('ä½¿ç”¨å®Œæ•´ä¸Šä¼ æ¨¡å¼')
						await uploadFileComplete(file)
					}

					// ä¸Šä¼ æˆåŠŸï¼Œä¸æ˜¾ç¤ºé‡æ–°ä¸Šä¼ æŒ‰é’®
				} catch (error) {
					showStatus(`ä¸Šä¼ å‡ºé”™: ${error.message}`, 'error')
					console.error('ä¸Šä¼ å¼‚å¸¸:', error)
					// ä¸Šä¼ å¤±è´¥æ—¶æ˜¾ç¤ºé‡æ–°ä¸Šä¼ æŒ‰é’®
					reuploadBtn.classList.add('show')
				} finally {
					currentUploadController = null
				}
			}

			// ç‚¹å‡»ä¸Šä¼ åŒºåŸŸ
			uploadArea.addEventListener('click', () => {
				fileInput.click()
			})

			// æ–‡ä»¶é€‰æ‹©
			fileInput.addEventListener('change', (event) => {
				const file = event.target.files[0]
				if (file) {
					uploadFile(file)
				}
			})

			// æ‹–æ‹½ä¸Šä¼ 
			uploadArea.addEventListener('dragover', (e) => {
				e.preventDefault()
				uploadArea.classList.add('dragging')
			})

			uploadArea.addEventListener('dragleave', () => {
				uploadArea.classList.remove('dragging')
			})

			uploadArea.addEventListener('drop', (e) => {
				e.preventDefault()
				uploadArea.classList.remove('dragging')

				const file = e.dataTransfer.files[0]
				if (file) {
					uploadFile(file)
				}
			})

			// é‡æ–°ä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
			reuploadBtn.addEventListener('click', () => {
				if (lastUploadedFile) {
					console.log('é‡æ–°ä¸Šä¼ æ–‡ä»¶:', lastUploadedFile.name)
					uploadFile(lastUploadedFile)
				} else {
					showStatus('é”™è¯¯ï¼šæ²¡æœ‰å¯é‡æ–°ä¸Šä¼ çš„æ–‡ä»¶ï¼', 'error')
				}
			})
		</script>
	</body>
</html>
